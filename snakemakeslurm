#!/bin/bash -l

if [ "$1" == "--clean-scratch" ]
then
    for job in $(ls slurm_job_status)
    do
        hostname=$(cat slurm_job_status/$job)
        echo "$hostname $job"
        ssh $hostname rm -rf /scratch/$job
    done
    rm slurm_job_status/*
    exit 0
fi

SM_PARAMS="job-name partition mail-user mail-type output error time nodes mem exclude"
SM_ARGS="--ntasks {threads} --mem-per-cpu {cluster.mem-per-cpu}"
for P in ${SM_PARAMS}
do
    SM_ARGS="$SM_ARGS --$P {cluster.$P}"
done
echo "SM_ARGS: ${SM_ARGS}"

mkdir -p slurmout

srun \
        -N 1 -n 2 -t 5-0 --mail-user $USER_EMAIL --mail-type ALL \
        -o slurmout/snakemake_%A.log -e slurmout/snakemake_%A.err \
    $snakemake \
        $* \
        -j 999 \
        --latency-wait 30 \
        --cluster-config $(dirname $0)/slurm_config.yml \
        --cluster "sbatch $SM_ARGS" \
    &